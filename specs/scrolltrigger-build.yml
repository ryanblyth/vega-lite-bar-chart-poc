version: 1
name: scrolltrigger-animations
goal: >
  Add ScrollTrigger-powered bar growth animations with Lenis smooth scroll as an additional animation option.
  Bars should grow from bottom to top as user scrolls, with scrub functionality and smooth scrolling.
  The chart section should pin in place while bars grow, then unpin when animation completes.
  This feature should be easily toggleable and work alongside existing GSAP animations.

constraints:
  - Keep existing GSAP animations unchanged
  - Add ScrollTrigger + Lenis as additional option, not replacement
  - Use CDN for ScrollTrigger and Lenis dependencies
  - Maintain all existing functionality and configuration options
  - Keep ScrollTrigger code in separate file for modularity
  - Support both CSS class and JavaScript function control
  - Lenis should work seamlessly with ScrollTrigger

inputs:
  dependencies:
    - name: ScrollTrigger
      source: CDN
      url: https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js
      note: Must be loaded after GSAP
    - name: Lenis
      source: CDN
      url: https://cdn.jsdelivr.net/gh/studio-freight/lenis@1.0.19/bundled/lenis.min.js
      note: Smooth scroll library for enhanced ScrollTrigger experience

deliverables:
  - path: src/scrolltrigger.js
    type: module
    description: ScrollTrigger animation logic
  - path: src/index.html
    type: html
    description: Updated with ScrollTrigger CDN link
  - path: src/embed.js
    type: module
    description: Updated to integrate ScrollTrigger option
  - path: src/styles.css
    type: css
    description: Updated with ScrollTrigger configuration classes

public_api:
  functions:
    - name: toggleScrollTrigger
      parameters:
        enable: boolean
      description: Enable/disable ScrollTrigger animations and Lenis smooth scroll
    - name: isScrollTriggerEnabled
      returns: boolean
      description: Check if ScrollTrigger animations are currently enabled
    - name: refreshScrollTrigger
      parameters: []
      description: Refresh ScrollTrigger calculations after chart updates
    - name: toggleLenisSmoothScroll
      parameters:
        enable: boolean
      description: Enable/disable Lenis smooth scroll independently
    - name: isLenisEnabled
      returns: boolean
      description: Check if Lenis smooth scroll is currently enabled

  events:
    - name: scrolltrigger:ready
      detail_schema:
        trigger: object
        lenis: object
      description: Fired when ScrollTrigger and Lenis are initialized and ready
    - name: lenis:ready
      detail_schema:
        lenis: object
      description: Fired when Lenis smooth scroll is initialized

tasks:
  - id: scrolltrigger-cdn
    description: Add ScrollTrigger and Lenis CDN links to index.html
    acceptance:
      - ScrollTrigger CDN loaded after GSAP
      - Lenis CDN loaded after ScrollTrigger
      - CDN links point to correct versions
      - No conflicts with existing GSAP setup

  - id: scrolltrigger-module
    description: Create separate ScrollTrigger animation module with Lenis integration
    acceptance:
      - File: src/scrolltrigger.js
      - Contains ScrollTrigger animation logic with Lenis integration
      - Exports functions for enable/disable/refresh
      - Handles bar growth from bottom to top
      - Uses scrub for scroll-based animation
      - Pins chart container during bar growth animation
      - Unpins when bars reach full height
      - Initializes and manages Lenis smooth scroll instance

  - id: scrolltrigger-integration
    description: Integrate ScrollTrigger with existing embed.js
    acceptance:
      - ScrollTrigger option added to animation configuration
      - Works alongside existing GSAP animations
      - Respects existing animation control classes
      - ScrollTrigger refreshes when chart re-renders

  - id: scrolltrigger-config
    description: Add CSS classes and JavaScript functions for ScrollTrigger and Lenis control
    acceptance:
      - 'scroll-trigger-animations' class enables ScrollTrigger + Lenis
      - 'smooth-scroll' class enables Lenis independently
      - toggleScrollTrigger() function for dynamic control
      - toggleLenisSmoothScroll() function for Lenis-only control
      - isScrollTriggerEnabled() and isLenisEnabled() functions for status checking
      - refreshScrollTrigger() function for manual refresh

  - id: scrolltrigger-behavior
    description: Implement ScrollTrigger bar growth animation with Lenis smooth scroll and pinning
    acceptance:
      - Bars start with scaleY: 0 (bottom-aligned)
      - Bars grow to scaleY: 1 as user scrolls
      - Chart section pins in place while bars are growing
      - Chart unpins automatically when bars reach full height
      - Smooth scrub animation tied to scroll position
      - Lenis provides smooth scrolling experience
      - Animation triggers appropriately (chart can be immediately visible or scrolled to)
      - Works with existing bar selection and interactions
      - ScrollTrigger works with Lenis scroll events
      - Pin behavior uses anticipatePin for smooth performance

  - id: scrolltrigger-responsive
    description: Ensure ScrollTrigger and Lenis work on mobile and desktop
    acceptance:
      - ScrollTrigger works on mobile devices
      - Lenis smooth scroll works on mobile and desktop
      - Touch scrolling triggers animation correctly
      - Responsive behavior matches existing mobile features
      - No conflicts with mobile scroll functionality
      - Lenis respects mobile scroll preferences

checks:
  manual:
    - ScrollTrigger and Lenis CDNs load without errors
    - Bars grow smoothly as user scrolls down with smooth scroll
    - Chart pins in place while bars are growing
    - Chart unpins smoothly when bars reach full height
    - Lenis provides smooth scrolling experience
    - Animation can be toggled on/off via CSS class
    - Animation can be toggled on/off via JavaScript function
    - Lenis can be toggled independently of ScrollTrigger
    - ScrollTrigger works alongside existing GSAP animations
    - No conflicts with mobile scroll or other features
    - Animation resets properly when scrolling back up
    - Pinning works correctly when chart is immediately visible at page load
    - Smooth scroll works on mobile and desktop
    - Works in Chrome, Safari, Firefox

success_criteria:
  - ScrollTrigger animations work independently of existing GSAP animations
  - Chart pins smoothly during bar growth and unpins when complete
  - Lenis smooth scroll enhances the scrolling experience
  - Easy to enable/disable via CSS class or JavaScript function
  - Smooth bar growth animation tied to scroll position with scrub
  - Pinning behavior works when chart is immediately visible or requires scrolling
  - Lenis can be controlled independently of ScrollTrigger
  - No impact on existing functionality
  - Clean, modular code structure
  - Cross-browser compatibility maintained
  - Mobile-friendly scroll behavior with smooth scrolling and pinning
