
version: 1
name: co-cities-vegalite-top15
goal: >
  Implement a vertical Vega-Lite bar chart showing the Top 15 Colorado places by population.
  Bars sorted by population descending; optional color by density (/mi²).
  Emit a DOM CustomEvent `chart:selection` with `{ geoids: string[] }` on bar selection.
  Enhanced with GSAP animations, responsive mobile layout, and configurable features.

constraints:
  - Keep chart spec and theme in separate JSON files under `specs/vega-lite/`.
  - Data must be loaded from `/data/colorado-cities-enriched.geojson`.
  - Only Top 15 by population should be rendered.
  - Ensure chart is accessible and responsive.
  - Use GSAP for animations (loaded via CDN).
  - Support configurable mobile scroll and animation features.

inputs:
  data:
    path: data/colorado-cities-enriched.geojson
    type: geojson
    mapping:
      geoid: properties.GEOID
      name: properties.NAME
      pop: properties.Total_Pop
      aland_m2: properties.ALAND
    derived:
      density_per_sqmi: pop / (aland_m2 * 0.00000038610215855)

deliverables:
  - path: package.json
    type: node-package
  - path: specs/vega-lite/chart.json
    type: vega-lite-spec
  - path: specs/vega-lite/theme.json
    type: vega-lite-theme
  - path: src/index.html
    type: html
  - path: src/styles.css
    type: css
  - path: src/embed.js
    type: module

public_api:
  events:
    - name: chart:selection
      detail_schema:
        geoids: array[string]
      description: Fired whenever one or more bars are selected in the chart.
  
  functions:
    - name: toggleMobileScroll
      parameters:
        enable: boolean
      description: Enable/disable horizontal scroll on mobile devices.
    
    - name: toggleAnimations
      parameters:
        enable: boolean
      description: Enable/disable all bar animations globally.
    
    - name: toggleMobileAnimations
      parameters:
        enable: boolean
      description: Enable/disable bar animations on mobile devices only.
    
    - name: isMobileScrollEnabled
      returns: boolean
      description: Check if mobile scroll is currently enabled.
    
    - name: areAnimationsEnabled
      returns: boolean
      description: Check if animations are currently enabled.
    
    - name: areMobileAnimationsEnabled
      returns: boolean
      description: Check if mobile animations are currently enabled.

commands:
  dev: npm run dev
  build: npm run build
  preview: npm run preview

tasks:
  - id: scaffold
    description: Initialize Vite and dependencies (vega, vega-lite, vega-embed).
    acceptance:
      - package.json has dev/build/preview scripts.
      - App serves index.html at dev URL.

  - id: parse-geojson
    description: Transform FeatureCollection -> rows with {geoid, name, pop, density (/mi²)}.
    acceptance:
      - Invalid rows (missing geoid/name or non-finite pop) are filtered out.

  - id: theme
    description: Create theme.json and merge its `config` into the chart spec at runtime.
    acceptance:
      - Themed axes/legend/bar radius visible in render.

  - id: chart-spec
    description: Implement vertical bar chart (Top 15 by population).
    acceptance:
      - Use Vega-Lite `window` to compute rank by `pop` (descending) and filter `rank <= 15`.
      - x: name (ordinal), y: pop (quantitative), bars vertical.
      - Axis labels on x rotated to improve readability.
      - Tooltip shows name, GEOID, population (comma), density (comma).

  - id: color-density
    description: (Optional) Color bars by density (/mi²) with quantitative legend.
    acceptance:
      - If implemented, the legend renders and tooltips show density.

  - id: selection
    description: Add click selection by `geoid`; fade unselected; dblclick clears.
    acceptance:
      - Dispatch `chart:selection` with `{ geoids: [...] }`.
      - Console logs selected GEOIDs.

  - id: accessibility
    description: Basic a11y affordances.
    acceptance:
      - Container has role="img" and aria-labelledby.
      - Chart is keyboard reachable; tooltip does not trap focus.

  - id: gsap-animations
    description: Implement GSAP-powered bar entrance animations.
    acceptance:
      - Bars animate from scaleY: 0 to scaleY: 1 with staggered timing.
      - Animation duration 1.2s with power2.out easing.
      - Stagger delay of 0.05s between bars.
      - Initial state prevents flash before animation.

  - id: responsive-mobile
    description: Implement responsive mobile layout with horizontal scroll.
    acceptance:
      - Chart width 480px on mobile (≤480px) with horizontal scroll.
      - Legend positioned at bottom on mobile, right on desktop.
      - City labels sized appropriately (10px on small mobile).
      - Scroll indicator appears when chart is scrollable.

  - id: mobile-scroll-config
    description: Add configurable mobile scroll functionality.
    acceptance:
      - 'mobile-scroll' class enables/disables horizontal scroll.
      - toggleMobileScroll() function for dynamic control.
      - Scroll indicator shows/hides based on scroll state.

  - id: animation-config
    description: Add configurable animation system.
    acceptance:
      - 'no-animations' class disables all animations globally.
      - 'no-mobile-animations' class disables animations on mobile only.
      - toggleAnimations() and toggleMobileAnimations() functions.
      - shouldAnimate() function respects configuration classes.

  - id: y-axis-formatting
    description: Implement Y-axis number formatting with K notation.
    acceptance:
      - Numbers ≥1000 display as "K" format (e.g., "500K").
      - Numbers <1000 display with comma separators.
      - Formatting applied after chart render.

  - id: run-dev
    description: Launch dev server for manual QA.
    run: dev

checks:
  manual:
    - Exactly 15 bars render, sorted by population descending.
    - X labels readable (rotated/abbreviated) on a ~900px container.
    - Selection updates opacity and fires `chart:selection`.
    - Works in Chrome, Safari, Firefox.
    - Bar animations work smoothly with GSAP (when enabled).
    - Mobile layout scrolls horizontally with indicator (when enabled).
    - Y-axis numbers formatted with K notation for thousands.
    - Configuration classes work (mobile-scroll, no-animations, no-mobile-animations).
    - Utility functions work (toggleMobileScroll, toggleAnimations, etc.).

success_criteria:
  - Renders Top 15 correctly from uploaded GeoJSON.
  - `chart:selection` event emitted with correct GEOIDs.
  - Accessible structure and responsive labels.
  - Smooth GSAP animations with configurable on/off.
  - Responsive mobile layout with horizontal scroll option.
  - Y-axis number formatting with K notation.
  - Configurable features work via CSS classes and JavaScript functions.
  - Cross-browser compatibility maintained.
